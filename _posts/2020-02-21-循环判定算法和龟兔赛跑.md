---
layout: post
title:  "循环判定算法和龟兔赛跑"
date:   2020-02-21 10:00:00 -0000
categories: 技术
tags: 算法
---

这个问题是我在做SICP习题时遇到的, 要判断一个pair是否有循环结构，脱离`Lisp`的语境，可以理解为要判断一条单方向的路一直往前走，是否会遇到循环的死路。一种非常直观的想法是，记录所有经过的路劲，保存下来，如果第二次走到同样的地方时，就判定为有循环结构，这个很像在迷宫中的人做标记一样。

实现起来是很简单的，只需要一个数据结构记录所有走过的点，每经过一个点，判断之前是否已经走过。我们假设循环开始的点距离起点为`Cs`(cycle start), 循环的长度是`Cl`(cycle length), 因为第一次经过两次的点，刚好是循环开始的点，所以最终需要移动`Cs + Cl`步，同时需要记录`Cs + Cl`个节点的数据。时间和空间复杂度都是线性的(时间复杂度其实还要取决于判断是否相等的复杂度，这里假设用`HashMap`，复杂度为1）。

现在来思考另外一种情况，要求算法只有常数的空间复杂度。你是一个只有7秒钟记忆的鱼，没办法记得所有经过的点，怎么办呢？

一个思路是，假设只记住一个点(常数空间，对一个点或者几个点其实没有本质区别)，那么这个点就必须在循环体上，否则这个点是不会被重复经过的。那怎么知道点在循环体上呢？或者换一种提问，我们怎么找到一个在循环体上的点呢？可是等一下，我们用这个点是来判断循环的，而这个点的前提是他在循环体上，我们进入了一种循环论证。

所以这个思路是行不通的，那么还有什么办法呢。我们先看看能从线性空间复杂度的解决办法里得到什么，这里我们本质上解决的是什么问题？当再次经过同一个点时到底有什么特别的含义呢？通过记录，我们知道自己曾经走过这个地方。可不可以这样表述，现在的我和过去的我在这个点上**相遇**了，如果是循环，你总会和过去的你相遇。

好像有一点线索了，但是还不够清晰。

计算机领域充满了时间与空间的博弈，当题目要求用更少的空间的时候，几乎也意味着要用更多的时间。更多的时间，能给我们什么提示呢？线性空间的解法里，第一次遇到重复的点，刚好是循环的起点。那更多的时间，是不是意味着在更远的地方，相遇。和谁相遇呢？过去的自己吗，可是你是一条只能记住很少的鱼，记不得自己走过哪里了。

我们都有操场跑步的经历，跑得快的人会超过跑得慢的人一圈两圈。这就是问题的关键所在了，在循环体上，在前面的跑得快的总会赶上跑得慢的。反过来也是一样，只要我们用两个不同速度的人从同一起点出发，如果最后他们都相遇，那说明路径上是存在循环体的。

钟表上的秒针会跟12点的刻度重逢，也会和分针时针重逢。

![algorithm]({{"img/algorithm.png" | absolute_url }})

知道解法后，实现就简单了:  

``` 
(define (double-cdr x)
  (if (null? (cdr x))
      '()
      (cddr x)))
(define (contains-cycle x)
  (define (travel x y)
    (if (null?  x)
        #f
        (if (eq? (car x) (car y))
            #t
            (travel (double-cdr x) (cdr y)))))
  (travel (cdr x) x))  
```  

---  

我们都有这种时刻，知道答案后恍然大悟，觉得很简单，但是知道之前，却一筹莫展，答案简单，得到答案却不简单。写这篇文章的时候我一直试图想通过一种方式来逼近最后的方法，我想呈现的是路径而不是答案，但是这个过程并没有必然性，想到用龟兔赛跑的方式来解题还是一种灵光乍现。



